\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{amiri}[2009/12/28 Amiri font support package]

\RequirePackage{fontspec}[2009/12/12]
\RequirePackage{luacode}

\setmainfont[Script=Arabic]{Amiri}

\ExplSyntaxOn

\newcommand{\rtl} [1] {
  \xetex_or_luatex:nn {
    \TeXXeTstate=1\beginR #1\endR
   }{
    \luatextextdir TRT #1
   }
}

\begin{luacode}
luatexbase.require_module("amiri")
luatexbase.add_to_callback("pre_linebreak_filter",  amiri.initialise, "Amiri initialisation (pre_line)", 1)
luatexbase.add_to_callback("hpack_filter",          amiri.initialise, "Amiri initialisation (hpack)",    1)

luatexbase.add_to_callback("post_linebreak_filter", amiri.finalise,    "Amiri finalisation")
\end{luacode}
